| name address user users password message error |"Create a New User, who is owner of this site, based on owner and address fields"name _ request fieldsKey: 'owner' ifAbsent: [''].address _ request fieldsKey: 'address' ifAbsent: [''].(name = '') ifFalse: [	users _ shelf modulesAt: 'users'.	(user _ users userAtName: name ifAbsent: [nil])		ifNil: ["Can create new user"			"only if e-mail address is valid"			(NuSwikiPage isTextAnEmailAddress: address) ifTrue: [				"Generate Password"				password _ book formatPrivAddress: 'generatePassword' request: request response: response shelf: shelf.				request settingsAt: 'password' put: password.				request settingsAt: 'username' put: name.				"Send E-mail"				message _ TextFormatter crlfToCr: (book formatBookTemplate: 'registrationCreate' request: request response: response shelf: shelf).				error _ false.				[SMTPClient deliverMailFrom: (book settingsAt: 'alertSender') to: (OrderedCollection with: address) text: message usingServer: (book settingsAt: 'alertServer')] ifError: [:a :b | error _ true].				error					ifTrue: ["TODO"]					ifFalse: ["Create a new User"						user _ users addNewUserNamed: name.						user							address: address;							password: password;							home: book;							save]]]		ifNotNil: ["A user by that name already exists"			user				home: book;				save]]