| users error address password message newUser username |users _ shelf modulesAt: 'users'.username _ request fieldsKey: 'user'.request settingsAt: 'username' put: username.((users hasUserNamed: username) or: [username = ''])	ifTrue: [book formatBookTemplate: 'registrationFailedUser' request: request response: response shelf: shelf]	ifFalse: [		error _ false.		address _ request fieldsKey: 'address'.		"Generate Password"		password _ book formatPrivAddress: 'generatePassword' request: request response: response shelf: shelf.		request settingsAt: 'password' put: password.		"Send E-mail"		message _ TextFormatter crlfToCr: (book formatBookTemplate: 'registration' request: request response: response shelf: shelf).		[SMTPClient deliverMailFrom: (book settingsAt: 'alertSender') to: (OrderedCollection with: address) text: message usingServer: (book settingsAt: 'alertServer')] ifError: [:a :b | error _ true].		error			ifTrue: [book formatBookTemplate: 'registrationFailedEmail' request: request response: response shelf: shelf]			ifFalse: [				newUser _ users addNewUserNamed: username.				newUser					address: address;					password: password;					save.				book formatBookTemplate: 'registrationSuccess' request: request response: response shelf: shelf]]